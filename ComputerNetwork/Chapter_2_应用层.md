# 第二章 应用层

## 应用层原理

### 结构体系

+ 客户——服务器体系结构（client-server architecture）
    1. 有一个总是打开的主机，称为 **服务器**
    2. 其服务来自 **客户** 的主机请求
    3. 客户之间不直接通信
    4. 该服务器具有一个固定的、周知的地址，该地址称为 **IP地址**
+ P2P体系结构（P2P architecture）
    1. 对位于数据中心的专用服务器有最小的（或者没有）依赖
    2. 应用程序在间接连接的主机之间直接通信，这些这些 *主机对* 称为 **对等方**
    3. 自扩展性
    4. 成本有效的：不需要庞大的服务器基础设施和服务器带宽

### 进程通信

+ 客户和服务器进程
    1. 对每对通信进程，将其中之一标识为客户，另一个进程标识为服务器
    2. 对于web，Web服务器是一个服务器进程，浏览器是一个客户进程
    3. 对于P2P文件共享，下载文件的对等方标识为客户，上传文件的对等方标识为服务器
    4. 总结：在给定的一对进程之间的通信会话场景中，发起通信的进程称之为客户，等待联系的进程称之为服务器
+ 进程与计算机网络之间的接口
    1. 进程通过 **套接字（socket）** 的软件接口向网络发送报文和从网络接收报文
    2. 套接字是同一台主机内应用层与运输层之间的接口
    3. 套接字也称为应用程序和网络之间的API
    4. 套接字可以控制应用层的一切
    5. 套接字能控制的运输层的权限仅限于：
        1. 选择运输层协议
        2. 也许能设定一个运输层协议
+ 进程寻址：使用IP地址

### 应用程序服务要求

1. 可靠数据传输
2. 吞吐量：可用吞吐量就是发送进程能够向接收进程交付比特的速率。具有吞吐量要求的应用程序称为 **带宽敏感的应用**，与之相对应的是 **弹性应用**
3. 定时
4. 安全性

### 因特网提供的运输服务

+ TCP服务
    1. 面向连接的服务：
       1. 在应用层数据报开始流动之前，TCP让客户和服务器相互交换运输层控制信息，握手阶段或，一个TCP连接就在两个进程的套接字之间建立
       2. 由TCP建立的连接是全双工的（双方进程可以同时在此连接上同时进行报文收发
    2. 可靠的数据传送服务
    3. 具有拥塞控制机制
+ UDP服务
    1. 是一种不提供不要服务的轻量级运输协议，仅提供最小服务
    2. 是无连接的，在两个进程通信之前没有握手过程
    3. 不具有拥塞控制机制
    4. 当进程将报文通过UDP发送到套接字是，并不能保证该报文将达到接收进程，该报文也可能是乱序到达的
    5. 可以以选定的任何速率向其下层（网络层）注入数据

### 应用层协议

+ 定义了运行在不同端系统上的应用程序进程是如何相互传递报文的
+ 应用层定义了：
    1. 交换的报文类型，如请求报文和响应报文
    2. 各种报文类型的语法
    3. 字段的语义
    4. 一个进程何时以及如何发送报文

## Web和HTTP

## HTTP

+ 超文本传输协议（HyperText Transfer Protocol）
+ 由客户程序和服务器程序实现
+ Web浏览器实现HTTP的客户端，用于储存Web对象，每个对象由URL寻址
+ 定义了Web客户向Web服务器请求Web页面的方式，以及服务器向客户传送Web页面的方式
+ HTTP使用TCP作为其支持运输协议
+ HTTP协议不用担心数据丢失
+ HTTP是 **无状态协议（stateless protocol）**，并不不保存关于客户的任何信息
+ Web服务器总是打开的，并具有一个固定的IP地址
+ 往返时间（Round-Trip Time RTT)：一个短分组从客户端到服务器再返回客户端的时间（短分组是一个抽象概念，不仅仅指一个packet）</br>
RTT = （传播时延 + 传输时延 + 排队时延 + 处理时延）* 2
+ 总的响应时间 = 2 * RTT + 接收整个HTML文件的时间
+ 三次握手传输HTML文件</br>![avatar](..\images\ComputerNetwork\三次握手传输HTML文件.png)
+ 带内传送（in-band）

### 非持续连接的HTTP

+ 每个TCP连接在服务器发送一个对象后关闭，即该连接并不为其他对象而持续下来
+ 如：一个Web page由一个HTML文本和十个JPEG图片构成，此web page有11个web对象，使用非持续连接的HTTP，传送该web page需要11次TCP连接
+ 可是设置对象的传送方式，串行（一个进程）或是并行（多个进程）
+ 缺点：Web服务器负担重

### 持续连接的HTTP

+ HTTP的默认模式是使用带流水线的的持续连接

### HTTP报文格式

+ 是一个字符串
+ 请求报文

    ```txt
    GET /somedir/page.html HTTP/1.1     \r
    Host: www.someschool.edu            \r\n
    Connection: close                   \r\n
    User-agent: Mozilla/5.0             \r\n
    Accpet-language: fr                 \r\n
    ```

    1. 第一行：**请求行**
        1. 组成：方法字段 + URL字段 + HTTP版本字段（方法字段有：GET, POST, HEAD, PUT和DELETE）
        2. 以`\r`结束
    2. 其后所有行：首部行
        1. Host：指明对象所在主机
        2. User-agent：指明用户代理
        3. 以`\r\n`结束
    3. 请求报文的通用格式</br>![avatar](..\images\ComputerNetwork\请求报文.png)

+ 响应报文

    ```txt
    Data: Tue, 09, Aug, 2011, 15:44:04 GMT
    Server: Apache/2.2.3 (CentOS)
    Last-Modified: Tue, 09, Aug, 2011, 15:11:03 GMT
    Content-Lenght: 6821
    Content-Type: text/html

    (data data data ...)
    ```

    1. 三个部分：初始状态行，6个首部行，实体体
    2. 实体体是报文的主要部分
    3. 响应报文的通用格式</br>![avatar](..\images\ComputerNetwork\响应报文.png)
    4. 响应状态码：
        1. 200 OK：请求成功，信息在返回的响应报文中
        2. 301 Moved Permanently：请求的对象已经被永久转移了，新的URL定义在响应报文的Location：首行部。客户软件将自动获取新的URL
        3. 400 Bad Request：一个通用擦错代码，指示该请求不能被服务器理解
        4. 404 Not Found：被请求的文档不在服务器上
        5. 505 HTTP Version Not Supported：服务器不支持请求报文使用的HTTP协议版本

### 用户与服务器的交互：cookie

+ 使得站点可以对用户进行跟踪
+ cookie技术的4个组件：
    1. 在HTTP响应报文中的一个cookie首部行
    2. 在HTTP请求报文中的一个cookie首部行
    3. 在用户端系统中保留一个cookie文件，并由用户的浏览器进行管理
    4. 位于Web站点的一个后端数据库
+ 跟踪图</br>![avatar](..\images\ComputerNetwork\用cookie跟踪用户状态.png)

### Web缓存

+ 有助于降低网络时延，降低成本，降低响应时间

### 条件GET方法

+ 内容：
    1. 请求报文中使用GET方法
    2. 请求报文中包含`If-Modified-Since：`首部行

## 文本传输协议：FTP

+ 使用两个 **并行** 的TCP连接来传输文件：
    1. 控制连接：在两台主机之间传输控制信息，如用户标识、口令、改变远程目录的命令以及“存放（put）”和“获取（get）”文件的命令
    2. 数据连接：用于实际发送一个文件
+ 因为使用独立的控制连接，所以也称为 **带外（out-of-band）**传送
+ 控制连接只有一条，贯穿整个会话，由于和远程主机交换指令
+ 数据连接，在一次数据传输后关闭，下次传送时，再创建一条新的TCP

### FTP命令与回答

+ 常见命令：
    1. USER username：用于向服务器传送用户标识
    2. PASS password：用于向服务器发送用户口令
    3. LIST：请求服务器回送当前远程目录中的所有文件列表，该文件列表通过一条数据TCP传送
    4. RETR filename：从远程主机当前目录检索文件，请求的文件通过数据TCP送回（get）
    5. STOR filename：在远程主机的目录上存放文件（put）
+ 常见回答：
    1. 331 Username OK，Password reqiured
    2. 125 Data connection already open; transfer staring
    3. 425 Can't open data connection
    4. 452 Error writing file

## 因特网中的电子邮件

+ 3个主要的组成部分
    1. 用户代理
    2. 邮件服务
    3. 简单邮件传输协议（SMTP）
+ 当一个邮件服务器向其他邮件服务器发送邮件是，它表现为SMTP的客户；反之，表现为SMTP的服务器
+ SMTP用于从发送方的邮件服务器发送报文到接收方的邮件服务器
+ SMTP是直连的，也就是直接作用于用户和服务器上，没有中间服务器进行转存
+ SMTP使用持续连接：如果发送邮件服务器有几个报文发往同一个邮件服务器，它可以通过同一个TCP连接发送这些所有的报文

### SMTP与HTTP的比较

>特征|SMTP|HTTP
>|:-|:---|:---|
>连接方式|持续连接|持续连接（持续HTTP）
>协议|主要是一个推协议（push protocol）</br>将邮件推送出去|主要是一个拉协议（pull protocol）</br>从web服务器上获取web对象（报文）
>报文格式|每个报文使用7bit ASCII码格式，若不是该格式（如二进制数据等），则要转换成该格式|不受限制
>文档处理|报文对象放在一个报文中|每个对象封装在自己的HTTP响应报文中

### 电子邮箱访问协议

+ 电子邮箱协议及其通信实体</br>![avatar](..\images\ComputerNetwork\电子邮箱协议及其通信实体.png)
+ POP3（三个阶段）：
    1. 特许：用户代理发送（以明文的形式）用户名和口令以鉴别用户
    2. 事务处理：用户代理取回报文。此时用户可以对报文做删除标记，以及获取邮件的统计信息
    3. 更新：用户发出`quit`命令之后，结束POP3会话，邮件服务器删除那些被标记为删除的报文
+ POP3没有给用户提供任何创建远程文件夹并为这些报文指派文件夹的方法
+ IMAP服务器把每个报文与一个文件夹联系起来

## DNS：Internet的目录服务

+ 识别主机的两种方式：主机名和IP地址
+ DNS：域名系统（Domain Name System）
+ DNS的组成：
    1. 一个由分层的DNS服务器（DNS server）实现的分布式数据库
    2. 一个使得主机能够查询分布式数据库的应用层协议
+ DNS server通常是运行BIND（Berkeley Internet Name Domain）软件的UNIX机器
+ DNS协议运行在UDP之上，使用 **53号端口**
+ DNS是应用层协议
+ 功能：
    1. 将用户提供的主机名解析为IP地址
    2. 主机别名：有着复杂主机能拥有一个或多个别名，应用程序可以调用DNS来获得主机名对应的规范主机名
    3. 邮件服务器别名
    4. 负载分配：DNS也用于在冗余的服务器之间进行负载分配

### DNS工作机理概

#### 1. 分布式、层次数据库

+ 3中类型的DNS服务器
    1. 根域名服务器（root）：13组，标号从A到M
    2. 顶级域名服务器（TDS）
    3. 权威域名服务器
+ 本地域名服务器（local DNS server）：也叫默认名字服务器
+ 两种查询方式：递归查询和迭代查询。理论上任何DNS查询可以是迭代也可以是递归

#### DNS缓存

+ 在一个请求链中，当某DNS服务器接收到一个DNS回答（例如，包含主机名到IP地址的映射）时，它能将该回答中的信息缓存在本地存储器中

### DNS记录和报文

+ DNS服务器存储了 **资源记录** （RR Resource Record），RR提供了主机名到IP地址的映射
+ RR是包含了下列字段的4元组：（Name, Value, Type, TTL）
    1. TTL是该记录的生存时间，决定了资源记录应当从缓存中删除的时间
    2. Name和Value的值取决于Type：
        >Type|Name|Value|作用
        >|:--|:---|:----|:--|
        >A|主机名|该主机名对应的IP地址|
        >NS|一个域|是一个知道如何获得该域中主机IP地址的权威DNS服务器的主机名|该记录用来沿着查询链来路由DNS查询
        >CNAME||Name的主机对应的规范主机名|该记录能够向查询的主机提供一个主机名对应的规范主机名
        >MX||别名为Name的邮件主机的规范主机名|允许邮件服务器主机名具有简单的别名

#### 1. DNS报文

+ 只有两种报文：查询报文和回答报文，并有着相同的格式</br>
![avatar](..\images\ComputerNetwork\DNS报文格式.png)

## P2P(P100)

## TCP套接字编程

+ 典型的网络应用是由一对程序（客户程序和服务器程序）组成
+ 当运行这两个程序时，创建了一个客户进程和一个服务器进程
+ 网络应用程序有两类：
    1. 一类是，实现在协议标准中定义的操作，这类应用程序是“开放的”，因为定义其操作规则，人所共知。只要两个程序都完全遵从RFC的各种规则，就能过交互操作
    2. 另一类是，专用的网络应用程序，由客户和服务器程序应用的应用层协议没有公开发布在某RFC中或是其他地方

### UDP套接字编程实验

+ Server需要在Client之前运行起来
+ 使用UDP的Client-Server应用程序</br>![avatar](..\images\ComputerNetwork\使用UDP的Client-Server应用程序.png)

### TCP套接字编程实验

+ UDP一样，也需要Server先运行
+ 使用TCP的Client-Server应用程序</br>![avatar](..\images\ComputerNetwork\使用TCP的Client-Server应用程序.png)
