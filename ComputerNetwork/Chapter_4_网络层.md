# 第四章 网络层

+ 构造网络层分组交付的方法：数据报模式和虚电路模式
+ 转发（forwarding）：涉及到分组在单一的路由器中从一条入链路到一条出链路的传送
+ 路由选择（routing）：涉及到一个网络的所有路由器，它们经路由选择协议共同交互，以决定分组从源到目的地节点所采用的路径

## 概述

### 转发和路由选择

+ 转发（forwarding）：当一个分组到达路由器的一条输出链路时，路由器必须将该分组移动到设当的输出链路
+ 路由选择（routing）：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径
+ 计算这些路径的算法称为 **路由选择算法（routing algorithm）**
+ 每台路由器具有一张 **转发表（forwarding table）**：路由器通过检测到达的分组首部字段的值来转发分组，并使用该值在该路由器的转发表中索引查询。在转发表中，首部值与输出链路标号形成映射

### 网络服务模型

+ **网络服务模型（network service model）** 定义了分组在发送与接收端体统之间的端到端运输特性
+ 特定服务包括：
    1. 确保交付
    2. 具有时延上街的确保交付
    3. 有序分组交付
    4. 确保最小带宽
    5. 确保最大时延抖动
    6. 安全性服务
+ 因特网的网络层提供单一的服务，称为 **尽最大努力交付（best-effort service）**

## 虚电路和数据报网络

+ 网络层中的连接和无连接服务于运输层中的类似，但也存在着重大差异：
    1. 在网络层中，这些服务是由网络成向运输层提供的主机到主机的服务（运输层中是进程到进程）
    2. 至今为止，所有的网络层体系结构中，网络层仅在连接和无连接两者之中选择一种（即要不是无连接，要不是有连接），而不会同时运行两种服务
    3. 仅在网络层提供 ***连接服务*** 的计算机网络称为 **虚电路（Virtual—Circuit，VC）网络**
    4. 仅在网络层提供 ***无连接服务*** 的计算机网络称为 **数据报网络（datagram network）**

### VC网络

+ VC的组成：
    1. 源到目的主机之间的路径（即一系列链路和路由器）
    2. VC号：沿着该路径的每段链路的一个号码
    3. 沿着该路径的每台路由器中转发表表项
+ 跨越一台路由器创建一个条新的VC，转发表增加一个新的表项；终止一条虚电路，沿着该路径每个表中的相应项将被删除
+ VC的三个阶段：
    1. VC建立：
        1. 发送运输层与网络层的联系
        2. 指定接收方地址
        3. 等待建立VC
        4. 网络层决定发送方与接收方之间的路径，也将沿着这条路径，为每个链路决定一个VC号，并为在该路径上每一个链路增加一个表项
        5. 在建立期间，还可以在预留该虚电路路径上的资源（如带宽）
    2. 数据传输
    3. 虚电路拆除
+ 端系统项网络发送VC启动与终止的报文，以及路由器之间传递的由于建立虚电路的报文，称之为 **信令报文（signaling message）**
+ 用来交换这些报文的协议称之为 **信令协议（signaling protocol）**

### 数据报网络

+ 在DN中，转发表通过路由选择算法进行修改，通常每1 ~ 5分钟左右更新一次
+ 当有一个目的地址可能与多个表项相匹配时，路由器使用 **最长前缀匹配规则（longest prefix matching rule）

## 路由器工作原理

+ 路由器体系结构</br>![avatar](../images/ComputerNetwork/路由器体系结构.png)
+ 路由器的4个组成部分
    1. 输入端口：
        1. 执行一条输入的物理链路与路由器相连接的物理层功能
        2. 执行需要与位于入链路远端的数据链路层交互的数据链路层的功能
    2. 交换结构：是一个路由器中的网络
    3. 输出端口
    4. 路由选择处理器：
        1. 执行路由选择协议
        2. 维护路由选择表以及连接的链路状态信息
        3. 为路由器计算转发表
        4. 执行网络管理功能

+ 这里的端口，是指物理的输入端口和输出端口
+ 转发功能有时总称为 **路由器转发平面（router forwarding plane，RFP）**，并总是由硬件实现
+ 路由器的控制功能，总称为 **路由器控制平面（router control plane，RCP）**，通常用软件实现，并在路由选择处理器上执行

### 输入端口

+ 输入端口处理</br>![avatar](../images/ComputerNetwork/输入端口处理.png)
+ 转发表的一份影子副本通常被存放在每个输入端口，转发表从路由选择处理器经独立总线复制到线路卡
+ 影子副本的使用，可以使得转发决策能在每个输入端口本地做出，不需要调用中央路由选择处理器，避免了集中式处理地瓶颈
+ 输入端口的动作：
    1. 检索转发表
    2. 物理层和链路层的处理
    3. 检查分组的版本号、校验和以及寿命字段，并重写校验和与寿命字段
    4. 更新网络管理的计数器（如接收到的IP数据报数目）

### 交换结构

+ 常见的三种交换技术：
    1. 经内存交换</br>![avatar](../images/ComputerNetwork/经内存交换.png)
    2. 经总线交换</br>![avatar](../images/ComputerNetwork/经总线交换.png)
    3. 经互联网交换</br>![avatar](../images/ComputerNetwork/经互联网交换.png)

### 输出端口

+ 输出端口处理</br>![avatar](../images/ComputerNetwork/输出端口处理.png)

### 何时出现排队

+ 经验方法，基于相对少量的TCP流量的排队动态分析：缓存数量（B）应当等于RTT乘以链路的容量（C）
    $$ B = RTT * C $$
+ 最近的理论和实验研究表明，当有大量的TCP流（N）流经一条链路时，公式变为：
    $$ B = RTT * C/\sqrt{R} $$
+ 输出端口排队的结果是，在输出端口上的一个 **分组调度程序（packet scheduler）** 必须在这些排队的分组中选出一个来发送。（算法有，如FCFS（先来先服务），WFQ（加权公平排队））
+ **主动队列管理（Active Queue Management，AQM）** 算法：在某些情况下，在缓存填满前便丢弃（或是在首部加标记）一个分组
+ **随即早期检测（Random Early Detection，RED）** 算法是一种推广的AQM

### 路由选择控制平面

+ 网络范围的RFP是分布式的

## 网际协议：因特网中的转发和编址

+ IP协议版本4：**IPv4**
+ IP协议版本6：**IPv6**
+ 因特网网络层的内部视图</br>![avatar](../images/ComputerNetwork/因特网网络层的内部结构.png)

### 数据报格式

+ IPv4数据报格式</br>![avatar](../images/ComputerNetwork/IPv4数据报格式.png)
+ 关键字段：
    1. 版本号：根据版本号确定数据报格式
    2. 首部长度：因为IPv4包含一些可变数量的选项，所以需要4 bit来确定数据报中数据部分实际从哪里开始
    3. 数据报长度：IP数据报的总长度（首部 + 数据）
    4. 标识、标志、片偏移
    5. 寿命：**（Time-To-Live，TTL）** 确保数据报不会永远在网络中循环，若TTL字段减为0，则该数据报需要被丢弃
    6. 协议：指示IP数据报的数据部分应交给哪个特定的运输层协议
    7. 首部校验和：数据报的校验和
    8. 源和目的IP地址
    9. 选项
    10. 数据（有效载荷）

#### IP数据报分片

+ 一个链路层帧能承载的最大数据量称为 **最大传送单元（Maximum Transmission Unit，MTU）**
+ 过长的数据报会被分成一个个，大小小于当前协议下MTU的 **片（fragment）** 继续传送
+ 片的组装，在目的主机中进行
+ 如果一个或多个片段没有到达目的地，则不完整的数据报被丢弃，且不会交给运输层。若运输层正在使用TCP，则TCP会让源以初始数据报来重传数据

### IPv4编址
