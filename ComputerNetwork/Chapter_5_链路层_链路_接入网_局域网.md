# 链路层：链路、接入网和局域网

## 链路层概述

+ 结点（node）：将运输链路层协议的任何设备，包括主机、路由器、交换机和WiFi接入点
+ 链路（link）：沿着通信路径连接相邻结点的通信信道
+ 通过特定的链路时，传输结点将数据分装在 **链路层帧（frame）** 中，并由该帧传送到链路中

### 链路层提供的服务

+ 能够提供的可能的服务包括：
    1. 成帧（framing）：一个帧由一个数据字段和若干个首部字段组成，其中网络层数据报插在数据段中
    2. 链路接入：**媒体访问控制（Medium Access Control，MAC）** 协议规定了帧在链路上传输的规则
    3. 可靠交付：当链路层协议提供可靠交付服务时，它保证无差错地经链路层移动每个网络层数据报。链路层地可靠交付通常是通过确认和重传取得到的
    4. 差错检测和纠正

### 链路层的实现

+ 链路层的主体部分在 **网络适配器（network adapter）** 中实现，有时也称为 **网络接口卡（Network Interface Card，NIC）**，其核心是链路层控制器

## 差错检测和纠正技术

+ 在发送结点，为了保护比特免受差错，使用 **差错检测和纠正比特（Error-Detection and-Correction，EDC）**，来增强数据
+ 三种技术：
    1. 奇偶校验：用来描述差错检测和纠正背后隐含的思想
    2. 检验和方法：通常更多地应用于运输层
    3. 循环冗余检测：通常更多地应用在适配器中的链路层

### 奇偶校验

+ 最简单的方式是使用单个 **奇偶校验位（parity bit）**
    1. 奇校验：选择 **校验比特值** 使得`d + 1`个bit数据中，有奇数个1
    2. 偶校验：选择 **校验比特值** 使得`d + 1`个bit数据中，有偶数个1
+ 这里的奇偶校验与硬件中的奇偶校验不同
+ 二维奇偶校验（two-dimensional parity）：
    1. 可以检测到出现了 *单个比特差错* 的事实，而且可以利用存在奇偶校验差错的列和行的索引来实际识别发生差错的比特，*并纠正它*
    2. 可以检测一个分组中 *两个比特差错的任何组合*，但 *不能纠正*
+ 接收方检测和纠正差错的能力被称为 **向前纠错（Forward Error Correction，FEC）**

### 校验和方法

+ 检验和方法需要相对小的分组开销

### 循环冗余检测

+ **循环冗余检测（Cyclic Redundancy Check，CRC）** 基于CRC编码，CRC编码也称为 **多项式编码（polynomial code）**，该编码能够将要发送地比特串看作为系数是0和1的一个多项式，对比特串的操作被解释为多项式算数

## 多路访问链路和协议

+ 两种类型的网络链路：**点对点链路（point-to-point protocol）**，**广播链路（broadcast link）**
+ 点对点链路：相关协议有
    1. **点对点协议（point-to-point protocol，PPP）**
    2. **高级数据链路控制（high-level data link control，HDLC）**
+ 广播链路：**多路访问协议（multiple access protocol）** 分为三类：
    1. **信道划分协议（channel partitioning protocol）**
    2. **随机接入协议（random access protocol）**
    3. **轮流协议（taking-turns protocol）**

### 信道划分协议

+ 用于在所有共享信道结点之间划分广播信道宽带的技术：
    1. 时分多路复用（TDM）
    2. 频分多路复用（FDM）
    3. 码分多址（Code Division Multiple Access，CDMA）
+ TDM
    1. 将时间划分为 **时间帧（time frame）**，并进一步将每一个TF划分为N个 **时隙（slot）**
    2. 选择slot长度应该是，一个slot能够传输单个分组
    3. 将每个slot分给N结点中的一个
    4. TDM在时间上共享广播信道
    5. 为结点分配时段
+ FDM
    1. FDM将R bps信道划分为不同的频段，每一个频段具有R/N带宽
    2. 将每个频段分配给N个结点中的一个
    3. FDM在频段上共享广播信道
    4. 为结点分配频段
+ CDMA
    1. 为结点分配不同的编码

### 随机接入协议

+ 一个传输结点总是以信道的全部速率（即R bps）进行发送
+ 当碰撞时，涉及碰撞的每个结点反复地重复发送它的分组（帧），直至该帧无碰撞地通过为止
+ 涉及碰撞的每个结点在重发该帧之前，等待一个随机的时延，并且随机时延的选择是独立的

#### 1. 时隙 ALOHA

+ ALOHA：夏威夷语中的你好
+ 高度分散，每个结点检测碰撞并且独立的决定重传时间
+ 需要在结点中对时隙同步
+ 时隙多路访问协议的效率定义为：当有大量活跃结点且每个结点总有大量的帧要发送时，长期运行中成功时隙的份额
+ 时隙 ALOHA的最大效率为：１/e = 0.37（推导过程略）

#### 2. Pure ALOHA（纯ALOHA协议）

+ Pure ALOHA的最大效率为：1/(2e)

#### 载波侦听多路访问（CSMA）

+ 规则：
    1. 载波侦听（carrier sensing）：一个结点在传输前先侦听信道
    2. 碰撞检测（collision detection）：如果结点检测到另一个结点正在传输干扰帧，就停止传输

#### 具有碰撞检测的载波侦听多路访问（CSMA/CD）

+ CSMA with Collision Detection：CSMA/CD
+ 运行总结：
    1. 适配器从网络层获得一条数据报，准备链路层帧，将其放入帧帧适配器缓存中
    2. 如果适配器听到信道空闲（即无信号能量从信道进入适配器），它开始传输帧。另一方面，如果适配器侦听到信道正在忙，它将等待，知道侦听到没有信号能量时才开始传输帧
    3. 在传输过程中，适配器监视来自其他使用广播信道得适配器的信号能量得存在
    4. 如果适配器传输整个帧而为检测到来自其他适配器得信号能量，该适配器就完成了该帧的传输。另一方面，如果适配器在传输时检测到来自其他适配器的信号能量，它就中止传输帧
    5. 中止传输后，适配器等待一个随机时间量，然后返回步骤2
+ 随机时间的设定：当碰撞结点数量较少时，时间间隔较短；当碰撞结点数量较大时，时间间隔较长
+ CSMA/CD的效率：
    $$ efficiency = \cfrac{1}{1 + \cfrac{5d_{prop}}{d_{trans}}} $$
    其中，$d_{prop}$ = 信号能量在任意两个适配器之间传播所需的最大时间</br>
    $d_{trans}$ = 传输一个最大长度的以太网帧的时间

### 轮流协议

+ **轮询协议（polling protocol）**：有一个主结点，主节点循环发送报文给其他结点
+ **令牌传递协议（token-passing protocol）**：没有主结点，取而代之的是在结点之间传输 令牌（token）

### DOCSIS：用于电缆因特网接入的链路层协议

+ **电缆调制解调器端接系统（Cable Modem Termination System，CMTS）**
+ **数据经电缆服务接口（Data-Over-Cable Service Interface / CMIS，DOCSIS）**

## 交换局域网

### 链路层寻址和ARP

+ 链路层地址有各种不同的称呼：**LAN地址**、**物理地址** 或是 **MAC地址**
+ MAC地址更为流行

#### MAC地址

+ MAC地址使用十六进制表示法
+ MAC地址被设计成永久的，但用软件改变一块适配器的MAC地址是可能的（只是暂时改变，重启会恢复）
+ 适配器的MAC地址是扁平结构的（这与层次结构相反），以物理形式固定下来，这意味，适配器物理位置的改变，不能改变其MAC地址
+ 一块适配器可以接收一个并非向它寻址的帧，当适配器接收到一个帧时，将检查该帧中的目的MAC地址是否与它自己的MAC地址匹配。若匹配，则提取数据；不匹配，则丢弃该帧
+ 当适配器需要让局域网中所有其他的适配器都接收到某一帧时，它会在目的地址字段中插入一个特殊的 **MAC广播地址**
+ MAC广播地址：48个连续的1组成的字符串，也就是 $(FF-FF-FF-FF-FF-FF)_{16}$

#### 地址解析协议（Address Resolution Protocol，ARP）

+ ARP将一个IP地址解析为一个MAC地址，并在很多方面与DNS类型，不同之处在于，DNS为在因特网中任何地方的主机解析主机名，而ARP只为在 ***同一个子网的主机和路由器接口*** 解析IP地址
+ 每台主机或是路由器在其内存中具有一个 **ARP表（ARP　table）**，其包含了IP地址到MAC地址的映射关系，也包含了每一个映射关系的TTL
+ 若ARP表中没有需要的映射，则需要发送发构造一个ARP分组，ARP的查询packet和响应packet的格式相同
    1. 发送方和接收方的IP地址及MAC地址
    2. 发送方使用MAC广播地址作为目的地址
    3. 匹配上的接收方发送回一个带有希望映射的响应ARP分组
    4. 匹配上的查询主机更新ARP表
+ 最好将ARP看作是跨域链路层和网络层两边的协议

#### 发送数据报到子网之外

1. 发送适配器将ARP查询分组的目的MAC地址设置为子网路由器的MAC地址，IP地址设为目的主机的IP地址
2. 子网路由器收到来自向它查询的ARP请求后，将数据帧向上传递给路由器的网路层
3. 路由器通过转发表，将IP数据报向目的IP地址方向的那个输出接口传送

### 以太网

#### 以太网帧结构
